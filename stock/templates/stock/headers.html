<!DOCTYPE html>
{% load static %}
<html lang="en" class="js">

<head>
    <base href="../">
    <meta charset="utf-8">
    <meta name="author" content="Softnio">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="./images/favicon.png">
    <title>Inventory System</title>
    <link rel="stylesheet" href="{% static 'css/dashlite.css' %}">
    <link id="skin-default" rel="stylesheet" href="{% static 'css/theme.css' %}">
    <link href="{% static 'js/jquery-ui-1.12.1/jquery-ui.min.css' %}" rel="stylesheet">
    <link href="{% static 'js/jquery-ui-1.12.1/jquery-ui.structure.min.css' %}" rel="stylesheet">
    <link href="{% static 'js/jquery-ui-1.12.1/jquery-ui.theme.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/all.css' %}" rel="stylesheet">
    <link href="{% static 'css/sweetalert2.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/navbar-top-fixed.css' %}" rel="stylesheet">

    <style>
        /* --- FIX: Push content down so header doesn't cover it --- */
        .nk-content { 
            padding-top: 85px !important; /* Added Top Padding */
            min-height: calc(100vh - 120px) !important; 
        }
        
        .nk-header-tools .user-info { display: block !important; margin-left: 10px !important; }
        .nk-header-tools .user-toggle { display: flex !important; align-items: center !important; }
        #qr-modal { z-index: 10000 !important; }
    </style>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>

<body class="nk-body npc-default has-sidebar ">
    
    <script>
        (function() {
            const savedTheme = localStorage.getItem('inventory_theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        })();
    </script>

    <div class="nk-app-root">
        <div class="nk-main ">
            <div class="nk-sidebar nk-sidebar-fixed is-light " data-content="sidebarMenu">
                <div class="nk-sidebar-element nk-sidebar-head">
                    <div class="nk-sidebar-brand">
                        <a href="/" class="logo-link nk-sidebar-logo">
                            <img class="logo-light logo-img" src="{% static 'images/logo.png' %}" alt="logo">
                            <img class="logo-dark logo-img" src="{% static 'images/logo-dark.png' %}" alt="logo-dark">
                        </a>
                    </div>
                    <div class="nk-menu-trigger mr-n2">
                        <a href="#" class="nk-nav-toggle nk-quick-nav-icon d-xl-none" data-target="sidebarMenu"><em class="icon ni ni-arrow-left"></em></a>
                        <a href="#" class="nk-nav-compact nk-quick-nav-icon d-none d-xl-inline-flex" data-target="sidebarMenu"><em class="icon ni ni-menu"></em></a>
                    </div>
                </div>
                <div class="nk-sidebar-element">
                    <div class="nk-sidebar-content">
                        <div class="nk-sidebar-menu" data-simplebar>
                            <ul class="nk-menu">
                                {% if request.user.is_authenticated %}
                                <li class="nk-menu-heading"><h6 class="overline-title text-primary-alt">Navigation</h6></li>
                                <li class="nk-menu-item"><a href="/" class="nk-menu-link"><span class="nk-menu-icon"><em class="icon ni ni-home-fill"></em></span><span class="nk-menu-text">Home</span></a></li>
                                
                                {% if perms.stock.add_stock %}
                                <li class="nk-menu-item"><a href="/add_stock" class="nk-menu-link"><span class="nk-menu-icon"><em class="icon ni ni-cart-fill"></em></span><span class="nk-menu-text">Add Stock</span></a></li>
                                {% endif %}
                                
                                <li class="nk-menu-item"><a href="/view_stock" class="nk-menu-link"><span class="nk-menu-icon"><em class="icon ni ni-activity-round-fill"></em></span><span class="nk-menu-text">View Stock</span></a></li>
                                <li class="nk-menu-item"><a href="/view_history" class="nk-menu-link"><span class="nk-menu-icon"><em class="icon ni ni-growth-fill"></em></span><span class="nk-menu-text">View History</span></a></li>
                                <li class="nk-menu-item"><a href="/dependent_forms" class="nk-menu-link"><span class="nk-menu-icon"><em class="icon ni ni-user-list-fill"></em></span><span class="nk-menu-text">Add Dependent Forms</span></a></li>
                                <li class="nk-menu-item"><a href="/depend_form_view" class="nk-menu-link"><span class="nk-menu-icon"><em class="icon ni ni-table-view-fill"></em></span><span class="nk-menu-text">View Dependent Forms</span></a></li>
                                <li class="nk-menu-item"><a href="/contacts" class="nk-menu-link"><span class="nk-menu-icon"><em class="icon ni ni-note-add"></em></span><span class="nk-menu-text">Contacts</span></a></li>
                                {% endif %}
                                
                                {% if request.user.is_authenticated %}
                                <li style="display:none" class="nk-menu-item"><a href="/register" class="nk-menu-link"><span class="nk-menu-icon"><em class="ni ni-signin"></em></span><span class="nk-menu-text">Register</span></a></li>
                                {% else %}
                                <li class="nk-menu-item"><a href="/register" class="nk-menu-link"><span class="nk-menu-icon"><em class="ni ni-signin"></em></span><span class="nk-menu-text">Register</span></a></li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nk-wrap ">
                <div class="nk-header nk-header-fixed is-light">
                    <div class="container-fluid">
                        <div class="nk-header-wrap">
                            <div class="nk-menu-trigger d-xl-none ml-n1">
                                <a href="#" class="nk-nav-toggle nk-quick-nav-icon" data-target="sidebarMenu"><em class="icon ni ni-menu"></em></a>
                            </div>
                            <div class="nk-header-brand d-xl-none">
                                <a href="/" class="logo-link">
                                    <img class="logo-light logo-img" src="{% static 'images/logo.png' %}" alt="logo">
                                    <img class="logo-dark logo-img" src="{% static 'images/logo-dark.png' %}" alt="logo-dark">
                                </a>
                            </div>
                            
                            <div class="nk-header-search ml-3 ml-xl-0 d-flex align-items-center">
                                <em class="icon ni ni-search"></em>
                                <input type="text" class="form-control border-transparent form-focus-none" placeholder="Search anything">
                                <button type="button" class="btn btn-icon btn-sm btn-primary ml-2" onclick="startScanner()" title="Scan QR Code">
                                    <em class="icon ni ni-camera-fill"></em>
                                </button>
                            </div>

                            <div class="nk-header-tools">
                                <ul class="nk-quick-nav">
                                    <li class="mr-2">
                                        <a href="{% url 'view_cart' %}" class="btn btn-icon btn-sm btn-outline-light" title="View Issue Cart">
                                            <em class="icon ni ni-cart-fill" style="font-size: 1.5em;"></em>
                                        </a>
                                    </li>

                                    <li class="dropdown user-dropdown">
                                        <a href="#" class="dropdown-toggle mr-n1" data-toggle="dropdown">
                                            <div class="user-toggle">
                                                <div class="user-avatar sm">
                                                    <em class="icon ni ni-user-alt"></em>
                                                </div>
                                                <div class="user-info">
                                                    <div class="user-name dropdown-indicator">{{ user }}</div>
                                                </div>
                                            </div>
                                        </a>
                                        <div class="dropdown-menu dropdown-menu-md dropdown-menu-right">
                                            <div class="dropdown-inner user-card-wrap bg-lighter">
                                                <div class="user-card">
                                                    <div class="user-avatar">
                                                        <span>AB</span>
                                                    </div>
                                                    <div class="user-info">
                                                        <span class="lead-text">{{ user }}</span>
                                                        <span class="sub-text">{{ user.email }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="dropdown-inner">
                                                <ul class="link-list">
                                                    <li><a class="dark-switch" href="#"><em class="icon ni ni-moon"></em><span>Dark Mode</span></a></li>
                                                </ul>
                                            </div>
                                            <div class="dropdown-inner">
                                                <ul class="link-list">
                                                    {% if request.user.is_authenticated %}
                                                    <li><a href="/accounts/logout"><em class="icon ni ni-signout"></em><span>Log out</span></a></li>
                                                    {% else %}
                                                    <li><a href="/accounts/login"><em class="icon ni ni-signout"></em><span>Log In</span></a></li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="qr-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:10px; width:400px; max-width:90%; text-align:center;">
        <h5>Scan Item QR Code</h5>
        <div id="reader" style="width:100%"></div>
        <button class="btn btn-danger mt-3" onclick="stopScanner()">Close Scanner</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const darkSwitch = document.querySelector('.dark-switch');
        if(darkSwitch) {
            darkSwitch.addEventListener('click', function(e) {
                setTimeout(function() {
                    if (document.body.classList.contains('dark-mode')) {
                        localStorage.setItem('inventory_theme', 'dark');
                    } else {
                        localStorage.setItem('inventory_theme', 'light');
                    }
                }, 50);
            });
        }
    });

    let html5QrcodeScanner;
    function startScanner() {
        document.getElementById('qr-modal').style.display = 'flex';
        html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Scan result: ${decodedText}`);
        html5QrcodeScanner.clear();
        document.getElementById('qr-modal').style.display = 'none';

        if (decodedText.includes("stock_detail")) {
            window.location.href = decodedText;
        } else {
            window.location.href = "/stock_detail/" + decodedText;
        }
    }

    function onScanFailure(error) { }

    function stopScanner() {
        if(html5QrcodeScanner) {
            html5QrcodeScanner.clear();
        }
        document.getElementById('qr-modal').style.display = 'none';
    }
</script>